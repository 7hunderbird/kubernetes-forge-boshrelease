#!/bin/bash
set -eu

PLANSRC=/var/vcap/jobs/kubernetes-blacksmith-plans/plans
SVCROOT=/var/vcap/data/blacksmith/kubernetes-forge/services
rm    -rf $SVCROOT
mkdir -p  $SVCROOT

# Copy the service definition stub for Blacksmith
cp $PLANSRC/service.yml $SVCROOT

<% p('plans').each do |id, plan| %>
##############################################
#
# Set up plan <%= id %>
#
PLANROOT="$SVCROOT/<%= id %>"
PLANTYPE="<%= plan["type"] || 'standalone' %>"

mkdir -p $PLANROOT
cat > $PLANROOT/plan.yml <<EOF
---
id: <%= id %>
name: <%= plan["name"] || id %>
limit: <%= plan["limit"] || 0 %>
description: |+
  <%= plan["description"] || 'no description provided' %>
EOF

for file in init credentials.yml manifest.yml; do
  cp $PLANSRC/$PLANTYPE/$file $PLANROOT/
done
chmod 0755 $PLANROOT/init

cat > $PLANROOT/params.yml <<EOF
---
# auto-generated by kubernetes-blacksmith-plans
# for plan-id <%= id %> (<%= plan["name"] || id %>)
meta:
  nodes:           <%= plan["nodes"]           || '3' %>
  azs:             <%= plan["azs"]             || '[z1,z2,z3]' %>
  network:         <%= plan["network"]         || 'kubernetes-service' %>
  node_cpu:        <%= plan["node_cpu"]        || '2' %>
  node_mem:        <%= plan["node_mem"]        || '2048' %>
  node_ephemeral:  <%= plan["node_ephemeral"]  || '20_480' %>
  node_persistent: <%= plan["node_persistent"] || '20_480' %>
EOF



<% end %>
